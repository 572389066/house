"use strict";const t=require("../z-paging-utils.js"),e=require("../z-paging-constant.js"),i=require("../z-paging-enum.js"),l={props:{useVirtualList:{type:Boolean,default:t.u.gc("useVirtualList",!1)},useCompatibilityMode:{type:Boolean,default:t.u.gc("useCompatibilityMode",!1)},extraData:{type:Object,default:function(){return t.u.gc("extraData",{})}},useInnerList:{type:Boolean,default:t.u.gc("useInnerList",!1)},forceCloseInnerList:{type:Boolean,default:t.u.gc("forceCloseInnerList",!1)},cellKeyName:{type:String,default:t.u.gc("cellKeyName","")},innerListStyle:{type:Object,default:function(){return t.u.gc("innerListStyle",{})}},innerCellStyle:{type:Object,default:function(){return t.u.gc("innerCellStyle",{})}},preloadPage:{type:[Number,String],default:t.u.gc("preloadPage",7),validator:e=>(e<=0&&t.u.consoleErr("preload-page必须大于0！"),e>0)},cellHeightMode:{type:String,default:t.u.gc("cellHeightMode",i.Enum.CellHeightMode.Fixed)},virtualListCol:{type:[Number,String],default:t.u.gc("virtualListCol",1)},virtualScrollFps:{type:[Number,String],default:t.u.gc("virtualScrollFps",80)}},data:()=>({virtualListKey:t.u.getInstanceId(),virtualPageHeight:0,virtualCellHeight:0,virtualScrollTimeStamp:0,virtualList:[],virtualPlaceholderTopHeight:0,virtualPlaceholderBottomHeight:0,virtualTopRangeIndex:0,virtualBottomRangeIndex:0,lastVirtualTopRangeIndex:0,lastVirtualBottomRangeIndex:0,virtualHeightCacheList:[],getCellHeightRetryCount:{fixed:0,dynamic:0},pagingOrgTop:-1,updateVirtualListFromDataChange:!1}),watch:{realTotalData(t){this.finalUseVirtualList&&(this.updateVirtualListFromDataChange=!0,this.$nextTick((()=>{t.length||this._resetDynamicListState(!this.isUserPullDown),this.getCellHeightRetryCount.fixed=0,t.length&&this.cellHeightMode===i.Enum.CellHeightMode.Fixed&&this.isFirstPage&&this._updateFixedCellHeight(),this._updateVirtualScroll(this.oldScrollTop)})))},virtualList(t){this.$emit("update:virtualList",t),this.$emit("virtualListChange",t)}},computed:{finalUseVirtualList(){return this.useVirtualList&&this.usePageScroll&&t.u.consoleErr("使用页面滚动时，开启虚拟列表无效！"),this.useVirtualList&&!this.usePageScroll},finalUseInnerList(){return this.useInnerList||this.finalUseVirtualList&&!this.forceCloseInnerList},finalCellKeyName(){return this.cellKeyName},finalVirtualPageHeight(){return this.virtualPageHeight>0?this.virtualPageHeight:this.windowHeight},virtualRangePageHeight(){return this.finalVirtualPageHeight*this.preloadPage},virtualScrollDisTimeStamp(){return 1e3/this.virtualScrollFps}},methods:{didUpdateVirtualListCell(t){if(this.cellHeightMode!==i.Enum.CellHeightMode.Dynamic)return;const e=this.virtualHeightCacheList[t];this._getNodeClientRect(`#zp-id-${t}`,this.finalUseInnerList).then((i=>{const l=i?i[0].height:0,a=l-e.height;e.height=l,e.totalHeight=e.lastHeight+l;for(let e=t+1;e<this.virtualHeightCacheList.length;e++){const i=this.virtualHeightCacheList[e];e===t+1&&(i.lastHeight=l),i.totalHeight+=a}}))},didDeleteVirtualListCell(t){if(this.cellHeightMode!==i.Enum.CellHeightMode.Dynamic)return;const e=this.virtualHeightCacheList[t];for(let i=t+1;i<this.virtualHeightCacheList.length;i++){const l=this.virtualHeightCacheList[i];i===t+1&&(l.lastHeight=e.lastHeight),l.totalHeight-=e.height}this.virtualHeightCacheList.splice(t,1)},_virtualListInit(){this.$nextTick((()=>{setTimeout((()=>{this._getNodeClientRect(".zp-scroll-view").then((t=>{t&&(this.pagingOrgTop=t[0].top,this.virtualPageHeight=t[0].height)}))}),e.c.delayTime)}))},_updateFixedCellHeight(){this.$nextTick((()=>{const t=setTimeout((()=>{this._getNodeClientRect("#zp-id-0",this.finalUseInnerList).then((e=>{if(e)this.virtualCellHeight=e[0].height,this._updateVirtualScroll(this.oldScrollTop);else{if(clearTimeout(t),this.getCellHeightRetryCount.fixed>10)return;this.getCellHeightRetryCount.fixed++,this._updateFixedCellHeight()}}))}),e.c.delayTime)}))},_updateDynamicCellHeight(t){this.$nextTick((()=>{const i=setTimeout((async()=>{for(let l=0;l<t.length;l++){let a=t[l];const s=await this._getNodeClientRect(`#zp-id-${a[e.c.listCellIndexKey]}`,this.finalUseInnerList),h=s?s[0].height:0;if(!s){if(clearTimeout(i),this.virtualHeightCacheList=this.virtualHeightCacheList.slice(-l),this.getCellHeightRetryCount.dynamic>10)return;this.getCellHeightRetryCount.dynamic++,this._updateDynamicCellHeight(t);break}const r=this.virtualHeightCacheList.length?this.virtualHeightCacheList.slice(-1)[0]:null,n=r?r.totalHeight:0;this.virtualHeightCacheList.push({height:h,lastHeight:n,totalHeight:n+h})}this._updateVirtualScroll(this.oldScrollTop)}),e.c.delayTime)}))},_setCellIndex(t,l){let a=0;if(l)this._resetDynamicListState();else{a=this.realTotalData.length;const t=this.realTotalData.length?this.realTotalData.slice(-1)[0]:null;t&&void 0!==t[e.c.listCellIndexKey]&&(a=t[e.c.listCellIndexKey]+1)}for(let i=0;i<t.length;i++){let l=t[i];l&&"[object Object]"===Object.prototype.toString.call(l)||(l={item:l}),l[e.c.listCellIndexKey]=a+i,l[e.c.listCellIndexUniqueKey]=`${this.virtualListKey}-${l[e.c.listCellIndexKey]}`,t[i]=l}this.getCellHeightRetryCount.dynamic=0,this.cellHeightMode===i.Enum.CellHeightMode.Dynamic&&this._updateDynamicCellHeight(t)},_updateVirtualScroll(e,l=0){const a=t.u.getTime();if(0===e&&this._resetTopRange(),0!==e&&this.virtualScrollTimeStamp&&a-this.virtualScrollTimeStamp<=this.virtualScrollDisTimeStamp)return;this.virtualScrollTimeStamp=a;let s=0;const h=this.cellHeightMode;if(h===i.Enum.CellHeightMode.Fixed)s=parseInt(e/this.virtualCellHeight)||0,this._updateFixedTopRangeIndex(s),this._updateFixedBottomRangeIndex(s);else if(h===i.Enum.CellHeightMode.Dynamic){const t=l>0?"top":"bottom",i=this.virtualRangePageHeight,a=e-i,s=e+this.finalVirtualPageHeight+i;let h=0,r=0,n=!1;const o=this.virtualHeightCacheList,u=o?o.slice(-1)[0]:null;let g=this.virtualTopRangeIndex;if("bottom"===t)for(let e=g;e<o.length;e++){const t=o[e];if(t&&t.totalHeight>a){this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=t.lastHeight;break}}else{let t=!1;for(let e=g;e>=0;e--){const i=o[e];if(i&&i.totalHeight<a){this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=i.lastHeight,t=!0;break}}!t&&this._resetTopRange()}for(let e=this.virtualTopRangeIndex;e<o.length;e++){const t=o[e];if(t&&t.totalHeight>s){h=e,r=u.totalHeight-t.totalHeight,n=!0;break}}n&&0!==this.virtualBottomRangeIndex?(this.virtualBottomRangeIndex=h,this.virtualPlaceholderBottomHeight=r):(this.virtualBottomRangeIndex=this.realTotalData.length?this.realTotalData.length-1:this.pageSize,this.virtualPlaceholderBottomHeight=0),this._updateVirtualList()}},_updateFixedTopRangeIndex(t){let e=0===this.virtualCellHeight?0:t-parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*this.preloadPage;e*=this.virtualListCol,e=Math.max(0,e),this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=e/this.virtualListCol*this.virtualCellHeight},_updateFixedBottomRangeIndex(t){let e=0===this.virtualCellHeight?this.pageSize:t+parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*(this.preloadPage+1);e*=this.virtualListCol,e=Math.min(this.realTotalData.length,e),this.virtualBottomRangeIndex=e,this.virtualPlaceholderBottomHeight=(this.realTotalData.length-e)*this.virtualCellHeight/this.virtualListCol,this._updateVirtualList()},_updateVirtualList(){(this.updateVirtualListFromDataChange||this.lastVirtualTopRangeIndex!==this.virtualTopRangeIndex||this.lastVirtualBottomRangeIndex!==this.virtualBottomRangeIndex)&&(this.updateVirtualListFromDataChange=!1,this.lastVirtualTopRangeIndex=this.virtualTopRangeIndex,this.lastVirtualBottomRangeIndex=this.virtualBottomRangeIndex,this.virtualList=this.realTotalData.slice(this.virtualTopRangeIndex,this.virtualBottomRangeIndex+1))},_resetDynamicListState(t=!1){this.virtualHeightCacheList=[],t&&(this.virtualList=[]),this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0},_resetTopRange(){this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0,this._updateVirtualList()},_checkVirtualListScroll(){this.finalUseVirtualList&&this.$nextTick((()=>{this._getNodeClientRect(".zp-paging-touch-view").then((t=>{const e=t?t[0].top:0;(!t||e===this.pagingOrgTop&&0!==this.virtualPlaceholderTopHeight)&&this._updateVirtualScroll(0)}))}))},_innerCellClick(t,e){this.$emit("innerCellClick",t,e)}}};exports.virtualListModule=l;
