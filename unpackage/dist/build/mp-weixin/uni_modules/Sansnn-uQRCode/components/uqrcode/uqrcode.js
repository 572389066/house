"use strict";const e=require("../../../../common/vendor.js"),t=require("../../js_sdk/uqrcode/uqrcode.js"),s=require("../../common/queue.js"),i=require("../../common/cache.js");let a=null;const o={name:"uqrcode",props:{canvasId:{type:String,required:!0},value:{type:[String,Number]},options:{type:Object,default:()=>({})},size:{type:[String,Number],default:200},sizeUnit:{type:String,default:"px"},fileType:{type:String,default:"png"},start:{type:Boolean,default:!0},auto:{type:Boolean,default:!0},hide:{type:Boolean,default:!1},type:{type:String,default:()=>"2d"},queue:{type:Boolean,default:!1},isQueueLoadImage:{type:Boolean,default:!1},loading:{type:Boolean,default:void 0},h5SaveIsDownload:{type:Boolean,default:!1},h5DownloadName:{type:String,default:"uQRCode"}},data:()=>({canvas:void 0,canvasType:void 0,canvasContext:void 0,makeDelegate:void 0,drawDelegate:void 0,toTempFilePathDelegate:void 0,makeExecuted:!1,makeing:!1,drawing:!1,isError:!1,error:void 0,isH5Save:!1,tempFilePath:"",templateOptions:{size:0,width:0,height:0,canvasWidth:0,canvasHeight:0,canvasTransform:"",canvasDisplay:!1},uqrcodeOptions:{data:""},plugins:[],makeingPattern:[[[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]]]}),watch:{type:{handler(e){["2d"].includes(e)?this.canvasType=e:this.canvasType=void 0},immediate:!0},value:{handler(){this.auto&&this.remake()}},size:{handler(){this.auto&&this.remake()}},options:{handler(){this.auto&&this.remake()},deep:!0},makeing:{handler(e){e||"function"==typeof this.toTempFilePathDelegate&&this.toTempFilePathDelegate()}}},mounted(){this.templateOptions.size="rpx"==this.sizeUnit?e.index.upx2px(this.size):this.size,this.templateOptions.width=this.templateOptions.size,this.templateOptions.height=this.templateOptions.size,this.templateOptions.canvasWidth=this.templateOptions.size,this.templateOptions.canvasHeight=this.templateOptions.size,"2d"==this.canvasType||(this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`),this.start&&this.make()},methods:{getTemplateOptions(){var t="rpx"==this.sizeUnit?e.index.upx2px(this.size):this.size;return n(this.templateOptions,{size:t,width:t,height:t})},getUqrcodeOptions(){return n(this.options,{data:String(this.value),size:Number(this.templateOptions.size)})},resetCanvas(e){this.templateOptions.canvasDisplay=!1,this.$nextTick((()=>{this.templateOptions.canvasDisplay=!0,this.$nextTick((()=>{e&&e()}))}))},async draw(i={},o=!1){if("function"!=typeof i.success&&(i.success=()=>{}),"function"!=typeof i.fail&&(i.fail=()=>{}),"function"!=typeof i.complete&&(i.complete=()=>{}),this.drawing){if(!o)return void(this.drawDelegate=()=>{this.draw(i,!0)})}else this.drawing=!0;if(!this.canvasId)return console.error("[uQRCode]: canvasId must be set!"),this.isError=!0,this.drawing=!1,i.fail({errMsg:"[uQRCode]: canvasId must be set!"}),void i.complete({errMsg:"[uQRCode]: canvasId must be set!"});if(!this.value)return console.error("[uQRCode]: value must be set!"),this.isError=!0,this.drawing=!1,i.fail({errMsg:"[uQRCode]: value must be set!"}),void i.complete({errMsg:"[uQRCode]: value must be set!"});this.templateOptions=this.getTemplateOptions(),this.uqrcodeOptions=this.getUqrcodeOptions(),"string"==typeof this.uqrcodeOptions.errorCorrectLevel&&(this.uqrcodeOptions.errorCorrectLevel=t.b.errorCorrectLevel[this.uqrcodeOptions.errorCorrectLevel]),void 0===this.options.useDynamicSize&&(this.uqrcodeOptions.useDynamicSize=!0);const n=a=new t.b;this.plugins.forEach((e=>n.register(e.plugin))),n.setOptions(this.uqrcodeOptions),n.make();let r=null;if("2d"===this.canvasType){const t=this.canvas=await new Promise((t=>{e.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec((e=>{t(e[0].node)}))}));r=this.canvasContext=t.getContext("2d"),this.templateOptions.canvasWidth=n.size,this.templateOptions.canvasHeight=n.size,this.templateOptions.canvasTransform="";const s=e.index.getSystemInfoSync().pixelRatio;t.width=n.dynamicSize*s,t.height=n.dynamicSize*s,r.scale(s,s),n.loadImage=this.getLoadImage((function(e){return new Promise(((s,i)=>{const a=t.createImage();a.src=e,a.onload=()=>{s(a)},a.onerror=e=>{i(e)}}))}))}else r=this.canvasContext=e.index.createCanvasContext(this.canvasId,this),this.templateOptions.canvasWidth=n.dynamicSize,this.templateOptions.canvasHeight=n.dynamicSize,this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`,n.loadImage=this.getLoadImage((function(t){return new Promise(((s,i)=>{if(t.startsWith("http"))e.index.getImageInfo({src:t,success:e=>{s(e.path)},fail:e=>{i(e)}});else{if(t.startsWith("."))throw console.error("[uQRCode]: 本地图片路径仅支持绝对路径！"),new Error("[uQRCode]: local image path only supports absolute path!");s(t)}}))}));n.canvasContext=r,setTimeout((()=>{var e=this.plugins.find((e=>e.name==n.style)),t=e?e.drawCanvas:"drawCanvas";(this.queue?()=>s.queueDraw.exec((()=>n[t]())):()=>n[t]())().then((()=>{if(this.drawDelegate){let e=this.drawDelegate;this.drawDelegate=void 0,e()}else this.drawing=!1,i.success()})).catch((e=>{if(console.log(e),this.drawDelegate){let e=this.drawDelegate;this.drawDelegate=void 0,e()}else this.drawing=!1,this.isError=!0,i.fail(e)})).finally((()=>{i.complete()}))}),300)},make(e={}){this.makeExecuted=!0,this.makeing=!0,this.isError=!1,"function"!=typeof e.success&&(e.success=()=>{}),"function"!=typeof e.fail&&(e.fail=()=>{}),"function"!=typeof e.complete&&(e.complete=()=>{}),this.resetCanvas((()=>{clearTimeout(this.makeDelegate),this.makeDelegate=setTimeout((()=>{this.draw({success:()=>{setTimeout((()=>{e.success(),this.complete(!0)}),300)},fail:t=>{e.fail(t),this.error=t,this.complete(!1,t.errMsg)},complete:()=>{e.complete(),this.makeing=!1}})}),300)}))},remake(e){this.$emit("change"),this.make(e)},complete(e=!0,t=""){e?this.$emit("complete",{success:e}):this.$emit("complete",{success:e,errMsg:t})},toTempFilePath(t={}){if("function"!=typeof t.success&&(t.success=()=>{}),"function"!=typeof t.fail&&(t.fail=()=>{}),"function"!=typeof t.complete&&(t.complete=()=>{}),!this.makeExecuted){console.error("[uQRCode]: make() 方法从未调用！请先成功调用 make() 后再进行操作。");var s={errMsg:"[uQRCode]: make() method has never been executed! please execute make() successfully before operating."};return t.fail(s),void t.complete(s)}if(this.isError)return t.fail(this.error),void t.complete(this.error);if(this.makeing)this.toTempFilePathDelegate=()=>{this.toTempFilePath(t)};else if(this.toTempFilePathDelegate=null,"2d"===this.canvasType)try{let s=null;s=e.toRaw(this.canvas).toDataURL(),t.success({tempFilePath:s}),t.complete({tempFilePath:s})}catch(i){t.fail(i),t.complete(i)}else e.index.canvasToTempFilePath({canvasId:this.canvasId,fileType:this.fileType,width:Number(this.templateOptions.canvasWidth),height:Number(this.templateOptions.canvasHeight),destWidth:Number(this.templateOptions.size),destHeight:Number(this.templateOptions.size),success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}},this)},save(t={}){"function"!=typeof t.success&&(t.success=()=>{}),"function"!=typeof t.fail&&(t.fail=()=>{}),"function"!=typeof t.complete&&(t.complete=()=>{}),this.toTempFilePath({success:s=>{if("2d"===this.canvasType){const i=new RegExp("^data:image/png;base64,","g"),a=s.tempFilePath.replace(i,""),o=e.wx$1.getFileSystemManager(),n=`${e.wx$1.env.USER_DATA_PATH}/${(new Date).getTime()}${Math.random().toString().split(".")[1]}.png`;o.writeFile({filePath:n,data:a,encoding:"base64",success:s=>{e.index.saveImageToPhotosAlbum({filePath:n,success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})}else e.index.saveImageToPhotosAlbum({filePath:s.tempFilePath,success:e=>{t.success(e)},fail:e=>{t.fail(e)},complete:()=>{t.complete()}})},fail:e=>{t.fail(e),t.complete(e)}})},onClick(e){this.$emit("click",e)},getInstance:()=>a,registerStyle(e){if("style"!=e.Type)return console.warn("[uQRCode]: registerStyle 仅支持注册 style 类型的扩展！"),{errMsg:"registerStyle 仅支持注册 style 类型的扩展！"};"function"==typeof e&&this.plugins.push({plugin:e,name:e.Name,drawCanvas:e.DrawCanvas})},getLoadImage(e){var t=this;return"function"==typeof e?function(a){return t.isQueueLoadImage?s.queueLoadImage.exec((()=>new Promise(((t,s)=>{setTimeout((()=>{const o=i.cacheImageList.find((e=>e.src==a));o?t(o.img):e(a).then((e=>{i.cacheImageList.push({src:a,img:e}),t(e)})).catch((e=>{s(e)}))}),10)})))):e(a)}:function(e){return Promise.resolve(e)}}}};function n(e={},t={},s=!1){let i;i=s?e:{...e};for(let o in t){var a=t[o];null!=a&&(a.constructor==Object?i[o]=this.deepReplace(i[o],a):a.constructor!=String||a?i[o]=a:i[o]=i[o])}return i}const r=e._export_sfc(o,[["render",function(t,s,i,a,o,n){return e.e({a:o.templateOptions.canvasDisplay},o.templateOptions.canvasDisplay?{b:i.canvasId,c:i.canvasId,d:o.canvasType,e:`${o.templateOptions.canvasWidth}px`,f:`${o.templateOptions.canvasHeight}px`,g:o.templateOptions.canvasTransform,h:e.o(((...e)=>n.onClick&&n.onClick(...e)))}:{},{i:void 0===i.loading?o.makeing:i.loading},(void 0===i.loading?o.makeing:i.loading)?{j:o.templateOptions.size/4+"px",k:o.templateOptions.size/4+"px"}:{},{l:o.isError},o.isError?{m:e.t(o.error.errMsg),n:e.r("error",{error:o.error}),o:e.o(((...e)=>n.onClick&&n.onClick(...e)))}:{},{p:i.hide?1:"",q:`${o.templateOptions.width}px`,r:`${o.templateOptions.height}px`})}],["__scopeId","data-v-db60d6c5"]]);wx.createComponent(r);
