"use strict";const s=require("../z-paging-utils.js"),o=require("../z-paging-constant.js"),c=require("../z-paging-enum.js"),I={props:{useVirtualList:{type:Boolean,default:s.u.gc("useVirtualList",!1)},useCompatibilityMode:{type:Boolean,default:s.u.gc("useCompatibilityMode",!1)},extraData:{type:Object,default:function(){return s.u.gc("extraData",{})}},useInnerList:{type:Boolean,default:s.u.gc("useInnerList",!1)},forceCloseInnerList:{type:Boolean,default:s.u.gc("forceCloseInnerList",!1)},cellKeyName:{type:String,default:s.u.gc("cellKeyName","")},innerListStyle:{type:Object,default:function(){return s.u.gc("innerListStyle",{})}},innerCellStyle:{type:Object,default:function(){return s.u.gc("innerCellStyle",{})}},preloadPage:{type:[Number,String],default:s.u.gc("preloadPage",7),validator:t=>(t<=0&&s.u.consoleErr("preload-page必须大于0！"),t>0)},cellHeightMode:{type:String,default:s.u.gc("cellHeightMode",c.Enum.CellHeightMode.Fixed)},virtualListCol:{type:[Number,String],default:s.u.gc("virtualListCol",1)},virtualScrollFps:{type:[Number,String],default:s.u.gc("virtualScrollFps",80)}},data(){return{virtualListKey:s.u.getInstanceId(),virtualPageHeight:0,virtualCellHeight:0,virtualScrollTimeStamp:0,virtualList:[],virtualPlaceholderTopHeight:0,virtualPlaceholderBottomHeight:0,virtualTopRangeIndex:0,virtualBottomRangeIndex:0,lastVirtualTopRangeIndex:0,lastVirtualBottomRangeIndex:0,virtualHeightCacheList:[],getCellHeightRetryCount:{fixed:0,dynamic:0},pagingOrgTop:-1,updateVirtualListFromDataChange:!1}},watch:{realTotalData(t){this.finalUseVirtualList&&(this.updateVirtualListFromDataChange=!0,this.$nextTick(()=>{t.length||this._resetDynamicListState(!this.isUserPullDown),this.getCellHeightRetryCount.fixed=0,t.length&&this.cellHeightMode===c.Enum.CellHeightMode.Fixed&&this.isFirstPage&&this._updateFixedCellHeight(),this._updateVirtualScroll(this.oldScrollTop)}))},virtualList(t){this.$emit("update:virtualList",t),this.$emit("virtualListChange",t)}},computed:{finalUseVirtualList(){return this.useVirtualList&&this.usePageScroll&&s.u.consoleErr("使用页面滚动时，开启虚拟列表无效！"),this.useVirtualList&&!this.usePageScroll},finalUseInnerList(){return this.useInnerList||this.finalUseVirtualList&&!this.forceCloseInnerList},finalCellKeyName(){return this.cellKeyName},finalVirtualPageHeight(){return this.virtualPageHeight>0?this.virtualPageHeight:this.windowHeight},virtualRangePageHeight(){return this.finalVirtualPageHeight*this.preloadPage},virtualScrollDisTimeStamp(){return 1e3/this.virtualScrollFps}},methods:{didUpdateVirtualListCell(t){if(this.cellHeightMode!==c.Enum.CellHeightMode.Dynamic)return;const e=this.virtualHeightCacheList[t];this._getNodeClientRect(`#zp-id-${t}`,this.finalUseInnerList).then(l=>{const i=l?l[0].height:0,a=i-e.height;e.height=i,e.totalHeight=e.lastHeight+i;for(let n=t+1;n<this.virtualHeightCacheList.length;n++){const u=this.virtualHeightCacheList[n];n===t+1&&(u.lastHeight=i),u.totalHeight+=a}})},didDeleteVirtualListCell(t){if(this.cellHeightMode!==c.Enum.CellHeightMode.Dynamic)return;const e=this.virtualHeightCacheList[t];for(let l=t+1;l<this.virtualHeightCacheList.length;l++){const i=this.virtualHeightCacheList[l];l===t+1&&(i.lastHeight=e.lastHeight),i.totalHeight-=e.height}this.virtualHeightCacheList.splice(t,1)},_virtualListInit(){this.$nextTick(()=>{setTimeout(()=>{this._getNodeClientRect(".zp-scroll-view").then(t=>{t&&(this.pagingOrgTop=t[0].top,this.virtualPageHeight=t[0].height)})},o.c.delayTime)})},_updateFixedCellHeight(){this.$nextTick(()=>{const t=setTimeout(()=>{this._getNodeClientRect(`#zp-id-${0}`,this.finalUseInnerList).then(e=>{if(e)this.virtualCellHeight=e[0].height,this._updateVirtualScroll(this.oldScrollTop);else{if(clearTimeout(t),this.getCellHeightRetryCount.fixed>10)return;this.getCellHeightRetryCount.fixed++,this._updateFixedCellHeight()}})},o.c.delayTime)})},_updateDynamicCellHeight(t){this.$nextTick(()=>{const e=setTimeout(async()=>{for(let l=0;l<t.length;l++){let i=t[l];const a=await this._getNodeClientRect(`#zp-id-${i[o.c.listCellIndexKey]}`,this.finalUseInnerList),n=a?a[0].height:0;if(!a){if(clearTimeout(e),this.virtualHeightCacheList=this.virtualHeightCacheList.slice(-l),this.getCellHeightRetryCount.dynamic>10)return;this.getCellHeightRetryCount.dynamic++,this._updateDynamicCellHeight(t);break}const u=this.virtualHeightCacheList.length?this.virtualHeightCacheList.slice(-1)[0]:null,d=u?u.totalHeight:0;this.virtualHeightCacheList.push({height:n,lastHeight:d,totalHeight:d+n})}this._updateVirtualScroll(this.oldScrollTop)},o.c.delayTime)})},_setCellIndex(t,e){let l=0;if(e)this._resetDynamicListState();else{l=this.realTotalData.length;const i=this.realTotalData.length?this.realTotalData.slice(-1)[0]:null;i&&i[o.c.listCellIndexKey]!==void 0&&(l=i[o.c.listCellIndexKey]+1)}for(let i=0;i<t.length;i++){let a=t[i];(!a||Object.prototype.toString.call(a)!=="[object Object]")&&(a={item:a}),a[o.c.listCellIndexKey]=l+i,a[o.c.listCellIndexUniqueKey]=`${this.virtualListKey}-${a[o.c.listCellIndexKey]}`,t[i]=a}this.getCellHeightRetryCount.dynamic=0,this.cellHeightMode===c.Enum.CellHeightMode.Dynamic&&this._updateDynamicCellHeight(t)},_updateVirtualScroll(t,e=0){const l=s.u.getTime();if(t===0&&this._resetTopRange(),t!==0&&this.virtualScrollTimeStamp&&l-this.virtualScrollTimeStamp<=this.virtualScrollDisTimeStamp)return;this.virtualScrollTimeStamp=l;let i=0;const a=this.cellHeightMode;if(a===c.Enum.CellHeightMode.Fixed)i=parseInt(t/this.virtualCellHeight)||0,this._updateFixedTopRangeIndex(i),this._updateFixedBottomRangeIndex(i);else if(a===c.Enum.CellHeightMode.Dynamic){const n=e>0?"top":"bottom",u=this.virtualRangePageHeight,d=t-u,f=t+this.finalVirtualPageHeight+u;let m=0,H=0,C=!1;const g=this.virtualHeightCacheList,L=g?g.slice(-1)[0]:null;let v=this.virtualTopRangeIndex;if(n==="bottom")for(let h=v;h<g.length;h++){const r=g[h];if(r&&r.totalHeight>d){this.virtualTopRangeIndex=h,this.virtualPlaceholderTopHeight=r.lastHeight;break}}else{let h=!1;for(let r=v;r>=0;r--){const p=g[r];if(p&&p.totalHeight<d){this.virtualTopRangeIndex=r,this.virtualPlaceholderTopHeight=p.lastHeight,h=!0;break}}!h&&this._resetTopRange()}for(let h=this.virtualTopRangeIndex;h<g.length;h++){const r=g[h];if(r&&r.totalHeight>f){m=h,H=L.totalHeight-r.totalHeight,C=!0;break}}!C||this.virtualBottomRangeIndex===0?(this.virtualBottomRangeIndex=this.realTotalData.length?this.realTotalData.length-1:this.pageSize,this.virtualPlaceholderBottomHeight=0):(this.virtualBottomRangeIndex=m,this.virtualPlaceholderBottomHeight=H),this._updateVirtualList()}},_updateFixedTopRangeIndex(t){let e=this.virtualCellHeight===0?0:t-parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*this.preloadPage;e*=this.virtualListCol,e=Math.max(0,e),this.virtualTopRangeIndex=e,this.virtualPlaceholderTopHeight=e/this.virtualListCol*this.virtualCellHeight},_updateFixedBottomRangeIndex(t){let e=this.virtualCellHeight===0?this.pageSize:t+parseInt(this.finalVirtualPageHeight/this.virtualCellHeight)*(this.preloadPage+1);e*=this.virtualListCol,e=Math.min(this.realTotalData.length,e),this.virtualBottomRangeIndex=e,this.virtualPlaceholderBottomHeight=(this.realTotalData.length-e)*this.virtualCellHeight/this.virtualListCol,this._updateVirtualList()},_updateVirtualList(){(this.updateVirtualListFromDataChange||this.lastVirtualTopRangeIndex!==this.virtualTopRangeIndex||this.lastVirtualBottomRangeIndex!==this.virtualBottomRangeIndex)&&(this.updateVirtualListFromDataChange=!1,this.lastVirtualTopRangeIndex=this.virtualTopRangeIndex,this.lastVirtualBottomRangeIndex=this.virtualBottomRangeIndex,this.virtualList=this.realTotalData.slice(this.virtualTopRangeIndex,this.virtualBottomRangeIndex+1))},_resetDynamicListState(t=!1){this.virtualHeightCacheList=[],t&&(this.virtualList=[]),this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0},_resetTopRange(){this.virtualTopRangeIndex=0,this.virtualPlaceholderTopHeight=0,this._updateVirtualList()},_checkVirtualListScroll(){this.finalUseVirtualList&&this.$nextTick(()=>{this._getNodeClientRect(".zp-paging-touch-view").then(t=>{const e=t?t[0].top:0;(!t||e===this.pagingOrgTop&&this.virtualPlaceholderTopHeight!==0)&&this._updateVirtualScroll(0)})})},_innerCellClick(t,e){this.$emit("innerCellClick",t,e)}}};exports.virtualListModule=I;
