"use strict";const a=require("../../../../../../common/vendor.js"),r=require("../z-paging-utils.js"),u=require("../z-paging-constant.js"),s=require("../z-paging-enum.js"),m={props:{refresherThemeStyle:{type:String,default:r.u.gc("refresherThemeStyle","")},refresherImgStyle:{type:Object,default:function(){return r.u.gc("refresherImgStyle",{})}},refresherTitleStyle:{type:Object,default:function(){return r.u.gc("refresherTitleStyle",{})}},refresherUpdateTimeStyle:{type:Object,default:function(){return r.u.gc("refresherUpdateTimeStyle",{})}},watchRefresherTouchmove:{type:Boolean,default:r.u.gc("watchRefresherTouchmove",!1)},loadingMoreThemeStyle:{type:String,default:r.u.gc("loadingMoreThemeStyle","")},refresherOnly:{type:Boolean,default:r.u.gc("refresherOnly",!1)},refresherDefaultDuration:{type:[Number,String],default:r.u.gc("refresherDefaultDuration",100)},refresherCompleteDelay:{type:[Number,String],default:r.u.gc("refresherCompleteDelay",0)},refresherCompleteDuration:{type:[Number,String],default:r.u.gc("refresherCompleteDuration",300)},refresherCompleteScrollable:{type:Boolean,default:r.u.gc("refresherCompleteScrollable",!1)},useCustomRefresher:{type:Boolean,default:r.u.gc("useCustomRefresher",!0)},refresherFps:{type:[Number,String],default:r.u.gc("refresherFps",40)},refresherMaxAngle:{type:[Number,String],default:r.u.gc("refresherMaxAngle",40)},refresherAngleEnableChangeContinued:{type:Boolean,default:r.u.gc("refresherAngleEnableChangeContinued",!1)},refresherDefaultText:{type:[String,Object],default:r.u.gc("refresherDefaultText",null)},refresherPullingText:{type:[String,Object],default:r.u.gc("refresherPullingText",null)},refresherRefreshingText:{type:[String,Object],default:r.u.gc("refresherRefreshingText",null)},refresherCompleteText:{type:[String,Object],default:r.u.gc("refresherCompleteText",null)},refresherDefaultImg:{type:String,default:r.u.gc("refresherDefaultImg",null)},refresherPullingImg:{type:String,default:r.u.gc("refresherPullingImg",null)},refresherRefreshingImg:{type:String,default:r.u.gc("refresherRefreshingImg",null)},refresherCompleteImg:{type:String,default:r.u.gc("refresherCompleteImg",null)},refresherEndBounceEnabled:{type:Boolean,default:r.u.gc("refresherEndBounceEnabled",!0)},refresherEnabled:{type:Boolean,default:r.u.gc("refresherEnabled",!0)},refresherThreshold:{type:[Number,String],default:r.u.gc("refresherThreshold","80rpx")},refresherDefaultStyle:{type:String,default:r.u.gc("refresherDefaultStyle","black")},refresherBackground:{type:String,default:r.u.gc("refresherBackground","transparent")},refresherFixedBackground:{type:String,default:r.u.gc("refresherFixedBackground","transparent")},refresherFixedBacHeight:{type:[Number,String],default:r.u.gc("refresherFixedBacHeight",0)},refresherOutRate:{type:Number,default:r.u.gc("refresherOutRate",.65)},refresherPullRate:{type:Number,default:r.u.gc("refresherPullRate",.75)},showRefresherUpdateTime:{type:Boolean,default:r.u.gc("showRefresherUpdateTime",!1)},refresherUpdateTimeKey:{type:String,default:r.u.gc("refresherUpdateTimeKey","default")},refresherVibrate:{type:Boolean,default:r.u.gc("refresherVibrate",!1)}},data(){return{R:s.Enum.Refresher,refresherStatus:s.Enum.Refresher.Default,refresherTouchstartY:0,lastRefresherTouchmove:null,refresherReachMaxAngle:!0,refresherTransform:"translateY(0px)",refresherTransition:"",finalRefresherDefaultStyle:"black",refresherRevealStackCount:0,refresherCompleteTimeout:null,refresherCompleteSubTimeout:null,refresherEndTimeout:null,isTouchmovingTimeout:null,refresherTriggered:!1,isTouchmoving:!1,isTouchEnded:!1,isUserPullDown:!1,privateRefresherEnabled:-1,privateShowRefresherWhenReload:!1,customRefresherHeight:-1,showCustomRefresher:!1,doRefreshAnimateAfter:!1,isRefresherInComplete:!1,pullDownTimeStamp:0,moveDis:0,oldMoveDis:0,currentDis:0,oldCurrentMoveDis:0,oldRefresherTouchmoveY:0,oldTouchDirection:"",oldPullingDistance:-1}},watch:{refresherDefaultStyle:{handler(e){e.length&&(this.finalRefresherDefaultStyle=e)},immediate:!0},refresherStatus(e){e===s.Enum.Refresher.Loading&&this._cleanRefresherEndTimeout(),this.refresherVibrate&&e===s.Enum.Refresher.ReleaseToRefresh&&this._doVibrateShort(),this.$emit("refresherStatusChange",e),this.$emit("update:refresherStatus",e)}},computed:{pullDownDisTimeStamp(){return 1e3/this.refresherFps},finalRefresherEnabled(){return this.useChatRecordMode?!1:this.privateRefresherEnabled===-1?this.refresherEnabled:this.privateRefresherEnabled===1},finalRefresherThreshold(){let e=this.refresherThreshold,t=!1;return e==="80rpx"&&(t=!0,this.showRefresherUpdateTime&&(e="120rpx")),t&&this.customRefresherHeight>0?this.customRefresherHeight:r.u.convertToPx(e)},finalRefresherFixedBacHeight(){return r.u.convertToPx(this.refresherFixedBacHeight)},finalRefresherThemeStyle(){return this.refresherThemeStyle.length?this.refresherThemeStyle:this.defaultThemeStyle},finalRefresherOutRate(){let e=this.refresherOutRate;return e=Math.max(0,e),e=Math.min(1,e),e},finalRefresherPullRate(){let e=this.refresherPullRate;return e=Math.max(0,e),e},finalRefresherTransform(){return this.refresherTransform==="translateY(0px)"?"none":this.refresherTransform},finalShowRefresherWhenReload(){return this.showRefresherWhenReload||this.privateShowRefresherWhenReload},finalRefresherTriggered(){return this.finalRefresherEnabled&&!this.useCustomRefresher?this.refresherTriggered:!1},showRefresher(){const e=this.finalRefresherEnabled&&this.useCustomRefresher;return this.customRefresherHeight===-1&&e&&setTimeout(()=>{this.$nextTick(()=>{this._updateCustomRefresherHeight()})},u.c.delayTime),e},hasTouchmove(){return this.watchRefresherTouchmove}},methods:{endRefresh(){this.totalData=this.realTotalData,this._refresherEnd(),this._endSystemLoadingAndRefresh()},handleRefresherStatusChanged(e){this.refresherStatusChangedFunc=e},_onRefresh(e=!1,t=!0){e&&!(this.finalRefresherEnabled&&!this.useCustomRefresher)||(this.$emit("onRefresh"),this.$emit("Refresh"),!(this.loading||this.isRefresherInComplete)&&(this.loadingType=s.Enum.LoadingType.Refresher,!this.nShowRefresherReveal&&(this.isUserPullDown=t,this.isUserReload=!t,this._startLoading(!0),this.refresherTriggered=!0,this.reloadWhenRefresh&&t&&(this.useChatRecordMode?this._onLoadingMore("click"):this._reload(!1,!1,t)))))},_onRestore(){this.refresherTriggered="restore",this.$emit("onRestore"),this.$emit("Restore")},_handleRefresherTouchstart(e){!this.loading&&this.isTouchEnded&&(this.isTouchmoving=!1),this.loadingType=s.Enum.LoadingType.Refresher,this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.isTouchEnded=!1,this.refresherTransition="",this.refresherTouchstartY=e.touchY,this.$emit("refresherTouchstart",this.refresherTouchstartY),this.lastRefresherTouchmove=e,this._cleanRefresherCompleteTimeout(),this._cleanRefresherEndTimeout()},_handleRefresherTouchmove(e,t){this.refresherReachMaxAngle=!0,this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.isTouchmoving=!0,this.isTouchEnded=!1,this.refresherStatus=e>=this.finalRefresherThreshold?s.Enum.Refresher.ReleaseToRefresh:this.refresherStatus=s.Enum.Refresher.Default,this.moveDis=e},_handleRefresherTouchend(e){this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this.refresherReachMaxAngle=!0,this.isTouchEnded=!0;const t=this.finalRefresherThreshold;e>=t&&this.refresherStatus===s.Enum.Refresher.ReleaseToRefresh?(setTimeout(()=>{this._emitTouchmove({pullingDistance:t,dy:this.moveDis-t})},.1),this.moveDis=t,this.refresherStatus=s.Enum.Refresher.Loading,this._doRefresherLoad()):(this._refresherEnd(),this.isTouchmovingTimeout=setTimeout(()=>{this.isTouchmoving=!1},this.refresherDefaultDuration)),this.scrollEnable=!0,this.$emit("refresherTouchend",e)},_handleListTouchstart(){this.useChatRecordMode&&this.autoHideKeyboardWhenChat&&(a.index.hideKeyboard(),this.$emit("hidedKeyboard"))},_handleScrollViewDisableBounce({bounce:e}){!this.usePageScroll&&!this.scrollToTopBounceEnabled&&(this.refresherTransition="",this.scrollEnable=e)},_handleWxsPullingDownStatusChange(e){this.wxsOnPullingDown=e,e&&!this.useChatRecordMode&&(this.renderPropScrollTop=0)},_handleWxsPullingDown({moveDis:e,diffDis:t}){this._emitTouchmove({pullingDistance:e,dy:t})},_handleTouchDirectionChange({direction:e}){this.$emit("touchDirectionChange",e)},_handlePropUpdate(){this.wxsPropType=r.u.getTime().toString()},_refresherEnd(e=!0,t=!1,o=!1,n=!0){if(this.loadingType===s.Enum.LoadingType.Refresher){const i=t&&(o||this.showRefresherWhenReload)?this.refresherCompleteDelay:0,f=i>0?s.Enum.Refresher.Complete:s.Enum.Refresher.Default;if(this.finalShowRefresherWhenReload){const h=this.refresherRevealStackCount;if(this.refresherRevealStackCount--,h>1)return}this._cleanRefresherEndTimeout(),this.refresherEndTimeout=setTimeout(()=>{this.refresherStatus=f},this.refresherStatus!==s.Enum.Refresher.Default&&f===s.Enum.Refresher.Default?this.refresherCompleteDuration:0),i>0&&(this.isRefresherInComplete=!0),this._cleanRefresherCompleteTimeout(),this.refresherCompleteTimeout=setTimeout(()=>{let h=1;const l=this.refresherEndBounceEnabled&&t?"cubic-bezier(0.19,1.64,0.42,0.72)":"linear";t&&(h=this.refresherEndBounceEnabled?this.refresherCompleteDuration/1e3:this.refresherCompleteDuration/3e3),this.refresherTransition=`transform ${t?h:this.refresherDefaultDuration/1e3}s ${l}`,this.wxsPropType=this.refresherTransition+"end"+r.u.getTime(),this.moveDis=0,f===s.Enum.Refresher.Complete&&(this.refresherCompleteSubTimeout&&(clearTimeout(this.refresherCompleteSubTimeout),this.refresherCompleteSubTimeout=null),this.refresherCompleteSubTimeout=setTimeout(()=>{this.$nextTick(()=>{this.refresherStatus=s.Enum.Refresher.Default,this.isRefresherInComplete=!1})},h*800)),this._emitTouchmove({pullingDistance:0,dy:this.moveDis})},i)}n&&(setTimeout(()=>{this.loading=!1},e?u.c.delayTime:0),o&&this._onRestore())},_doRefresherRefreshAnimate(){if(this._cleanRefresherCompleteTimeout(),!this.doRefreshAnimateAfter&&this.finalShowRefresherWhenReload&&this.customRefresherHeight===-1&&this.refresherThreshold==="80rpx"){this.doRefreshAnimateAfter=!0;return}this.refresherRevealStackCount++,this.wxsPropType="begin"+r.u.getTime(),this.moveDis=this.finalRefresherThreshold,this.refresherStatus=s.Enum.Refresher.Loading,this.isTouchmoving=!0,this.isTouchmovingTimeout&&clearTimeout(this.isTouchmovingTimeout),this._doRefresherLoad(!1)},_doRefresherLoad(e=!0){this._onRefresh(!1,e),this.loading=!0},_updateCustomRefresherHeight(){this._getNodeClientRect(".zp-custom-refresher-slot-view").then(e=>{this.customRefresherHeight=e?e[0].height:0,this.showCustomRefresher=this.customRefresherHeight>0,this.doRefreshAnimateAfter&&(this.doRefreshAnimateAfter=!1,this._doRefresherRefreshAnimate())})},_emitTouchmove(e){e.viewHeight=this.finalRefresherThreshold,e.rate=e.viewHeight>0?e.pullingDistance/e.viewHeight:0,this.hasTouchmove&&this.oldPullingDistance!==e.pullingDistance&&this.$emit("refresherTouchmove",e),this.oldPullingDistance=e.pullingDistance},_cleanRefresherCompleteTimeout(){this.refresherCompleteTimeout=this._cleanTimeout(this.refresherCompleteTimeout)},_cleanRefresherEndTimeout(){this.refresherEndTimeout=this._cleanTimeout(this.refresherEndTimeout)}}};exports.refresherModule=m;
