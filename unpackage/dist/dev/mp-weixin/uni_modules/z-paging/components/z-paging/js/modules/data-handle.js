"use strict";const g=require("../../../../../../common/vendor.js"),s=require("../z-paging-utils.js"),d=require("../z-paging-constant.js"),o=require("../z-paging-enum.js"),m=require("../z-paging-interceptor.js"),y={props:{defaultPageNo:{type:[Number,String],default:s.u.gc("defaultPageNo",1),observer:function(e){this.pageNo=e}},defaultPageSize:{type:[Number,String],default:s.u.gc("defaultPageSize",10),validator:e=>(e<=0&&s.u.consoleErr("default-page-size必须大于0！"),e>0)},dataKey:{type:[Number,String,Object],default:function(){return s.u.gc("dataKey",null)}},useCache:{type:Boolean,default:s.u.gc("useCache",!1)},cacheKey:{type:String,default:s.u.gc("cacheKey",null)},cacheMode:{type:String,default:s.u.gc("cacheMode",o.Enum.CacheMode.Default)},autowireListName:{type:String,default:s.u.gc("autowireListName","")},autowireQueryName:{type:String,default:s.u.gc("autowireQueryName","")},auto:{type:Boolean,default:s.u.gc("auto",!0)},reloadWhenRefresh:{type:Boolean,default:s.u.gc("reloadWhenRefresh",!0)},autoScrollToTopWhenReload:{type:Boolean,default:s.u.gc("autoScrollToTopWhenReload",!0)},autoCleanListWhenReload:{type:Boolean,default:s.u.gc("autoCleanListWhenReload",!0)},showRefresherWhenReload:{type:Boolean,default:s.u.gc("showRefresherWhenReload",!1)},showLoadingMoreWhenReload:{type:Boolean,default:s.u.gc("showLoadingMoreWhenReload",!1)},createdReload:{type:Boolean,default:s.u.gc("createdReload",!1)},localPagingLoadingTime:{type:[Number,String],default:s.u.gc("localPagingLoadingTime",200)},useChatRecordMode:{type:Boolean,default:s.u.gc("useChatRecordMode",!1)},autoHideKeyboardWhenChat:{type:Boolean,default:s.u.gc("autoHideKeyboardWhenChat",!0)},concat:{type:Boolean,default:s.u.gc("concat",!0)},value:{type:Array,default:function(){return[]}},modelValue:{type:Array,default:function(){return[]}}},data(){return{currentData:[],totalData:[],realTotalData:[],totalLocalPagingList:[],dataPromiseResultMap:{reload:null,complete:null,localPaging:null},isSettingCacheList:!1,pageNo:1,currentRefreshPageSize:0,isLocalPaging:!1,isAddedData:!1,isTotalChangeFromAddData:!1,privateConcat:!0,myParentQuery:-1,firstPageLoaded:!1,pagingLoaded:!1,loaded:!1,isUserReload:!0,fromEmptyViewReload:!1,queryFrom:"",listRendering:!1,listRenderingTimeout:null}},computed:{pageSize(){return this.defaultPageSize},finalConcat(){return this.concat&&this.privateConcat},finalUseCache(){return this.useCache&&!this.cacheKey&&s.u.consoleErr("use-cache为true时，必须设置cache-key，否则缓存无效！"),this.useCache&&!!this.cacheKey},finalCacheKey(){return this.cacheKey?`${d.c.cachePrefixKey}-${this.cacheKey}`:null},isFirstPage(){return this.pageNo===this.defaultPageNo}},watch:{totalData(e,t){this._totalDataChange(e,t)},currentData(e,t){this._currentDataChange(e,t)},useChatRecordMode(e,t){e&&(this.nLoadingMoreFixedHeight=!1)},value:{handler(e){this.realTotalData=e},immediate:!0},modelValue:{handler(e){this.realTotalData=e},immediate:!0}},methods:{complete(e,t=!0){return this.customNoMore=-1,this.addData(e,t)},completeByKey(e,t=null,a=!0){return t!==null&&this.dataKey!==null&&t!==this.dataKey?(this.isFirstPage&&this.endRefresh(),new Promise(i=>i())):(this.customNoMore=-1,this.addData(e,a))},completeByTotal(e,t,a=!0){if(t=="undefined")this.customNoMore=-1;else{const i=this._checkDataType(e,a,!1);if(e=i.data,a=i.success,t>=0&&a)return new Promise((r,l)=>{this.$nextTick(()=>{let h=!1,n=this.realTotalData.length;this.pageNo==this.defaultPageNo&&(n=0);const c=this.privateConcat?e.length:0;let u=n+c-t;u>=0&&(h=!0,u=this.defaultPageSize-u,u>0&&u<e.length&&this.privateConcat&&(e=e.splice(0,u))),this.completeByNoMore(e,h,a).then(f=>r(f)).catch(()=>l())})})}return this.addData(e,a)},completeByNoMore(e,t,a=!0){return t!="undefined"&&(this.customNoMore=t==!0?1:0),this.addData(e,a)},addData(e,t=!0){this.fromCompleteEmit||(this.disabledCompleteEmit=!0,this.fromCompleteEmit=!1);const i=s.u.getTime()-this.requestTimeStamp;let r=this.minDelay;this.isFirstPage&&this.finalShowRefresherWhenReload&&(r=Math.max(400,r));const l=this.requestTimeStamp>0&&i<r?r-i:0;return this.$nextTick(()=>{setTimeout(()=>{this._addData(e,t,!1)},this.delay>0?this.delay:l)}),new Promise((h,n)=>{this.dataPromiseResultMap.complete={resolve:h,reject:n}})},addDataFromTop(e,t=!0,a=!0){Object.prototype.toString.call(e)!=="[object Array]"&&(e=[e]),this.totalData=[...e,...this.totalData],t&&setTimeout(()=>{this._scrollToTop(a)},d.c.delayTime)},resetTotalData(e){this.isTotalChangeFromAddData=!0,Object.prototype.toString.call(e)!=="[object Array]"&&(e=[e]),this.totalData=e},addChatRecordData(e,t=!0,a=!0){Object.prototype.toString.call(e)!=="[object Array]"&&(e=[e]),this.useChatRecordMode&&(this.isTotalChangeFromAddData=!0,this.totalData=[...this.totalData,...e],t&&setTimeout(()=>{this._scrollToBottom(a)},d.c.delayTime))},setLocalPaging(e,t=!0){return this.isLocalPaging=!0,this.$nextTick(()=>{this._addData(e,t,!0)}),new Promise((a,i)=>{this.dataPromiseResultMap.localPaging={resolve:a,reject:i}})},reload(e=this.showRefresherWhenReload){return e&&(this.privateShowRefresherWhenReload=e,this.isUserPullDown=!0),this.listRendering=!0,this.$nextTick(()=>{this._preReload(e,!1)}),new Promise((t,a)=>{this.dataPromiseResultMap.reload={resolve:t,reject:a}})},refresh(){if(!this.realTotalData.length)return this.reload();const e=this.pageNo-this.defaultPageNo+1;if(e>=1){this.loading=!0,this.privateConcat=!1;const t=e*this.pageSize;this.currentRefreshPageSize=t,this._emitQuery(this.defaultPageNo,t,o.Enum.QueryFrom.Refresh),this._callMyParentQuery(this.defaultPageNo,t)}return new Promise((t,a)=>{this.dataPromiseResultMap.reload={resolve:t,reject:a}})},updateCache(){this.finalUseCache&&this.totalData.length&&this._saveLocalCache(this.totalData.slice(0,Math.min(this.totalData.length,this.pageSize)))},clean(){this._reload(!0),this._addData([],!0,!1)},clear(){this.clean()},doChatRecordLoadMore(){this.useChatRecordMode&&this._onLoadingMore("click")},_preReload(e=this.showRefresherWhenReload,t=!0){this.isUserReload=!0,this.loadingType=o.Enum.LoadingType.Refresher,e?(this.privateShowRefresherWhenReload=e,this.useCustomRefresher?this._doRefresherRefreshAnimate():this.refresherTriggered=!0):this._refresherEnd(!1,!1,!1,!1),this._reload(!1,t)},_reload(e=!1,t=!1,a=!1){this.isAddedData=!1,this.insideOfPaging=-1,this.cacheScrollNodeHeight=-1,this.pageNo=this.defaultPageNo,this._cleanRefresherEndTimeout(),!this.privateShowRefresherWhenReload&&!e&&this._startLoading(!0),this.firstPageLoaded=!0,this.isTotalChangeFromAddData=!1,this.isSettingCacheList||(this.totalData=[]),e||(this._emitQuery(this.pageNo,this.defaultPageSize,a?o.Enum.QueryFrom.UserPullDown:o.Enum.QueryFrom.Reload),setTimeout(()=>{this._callMyParentQuery()},0),!t&&this.autoScrollToTopWhenReload&&this._scrollToTop(!1)),this.$nextTick(()=>{})},_addData(e,t,a){this.isAddedData=!0,this.fromEmptyViewReload=!1,this.isTotalChangeFromAddData=!0,this.refresherTriggered=!1,this._endSystemLoadingAndRefresh();const i=this.isUserPullDown;this.showRefresherUpdateTime&&this.isFirstPage&&(s.u.setRefesrherTime(s.u.getTime(),this.refresherUpdateTimeKey),this.$refs.refresh&&this.$refs.refresh.updateTime()),!a&&i&&this.isFirstPage&&(this.isUserPullDown=!1);let r=this._checkDataType(e,t,a);e=r.data,t=r.success;let l=d.c.delayTime;if(this.loadingForNow=!1,setTimeout(()=>{this.pagingLoaded=!0,this.$nextTick(()=>{!a&&this._refresherEnd(l>0,!0,i)})},l),this.isFirstPage&&(this.isLoadFailed=!t,this.$emit("isLoadFailedChange",this.isLoadFailed),this.finalUseCache&&t&&(this.cacheMode===o.Enum.CacheMode.Always||this.isSettingCacheList)&&this._saveLocalCache(e)),this.isSettingCacheList=!1,t)if(this.privateConcat===!1&&this.loadingStatus===o.Enum.More.NoMore||(this.loadingStatus=o.Enum.More.Default),a){this.totalLocalPagingList=e;const h=this.defaultPageNo,n=this.queryFrom!==o.Enum.QueryFrom.Refresh?this.defaultPageSize:this.currentRefreshPageSize;this._localPagingQueryList(h,n,0,c=>{this.completeByTotal(c,this.totalLocalPagingList.length)})}else setTimeout(()=>{this._currentDataChange(e,this.currentData),this._callDataPromise(!0,this.totalData)},0);else this._currentDataChange(e,this.currentData),this._callDataPromise(!1),this.loadingStatus=o.Enum.More.Fail,this.loadingType===o.Enum.LoadingType.LoadingMore&&this.pageNo--},_totalDataChange(e,t,a=!0){(!this.isUserReload||!this.autoCleanListWhenReload)&&this.firstPageLoaded&&!e.length&&t.length||(this._doCheckScrollViewShouldFullHeight(e),!this.realTotalData.length&&!e.length&&(a=!1),this.realTotalData=e,a&&(this.$emit("input",e),this.$emit("update:modelValue",e),this.$emit("update:list",e),this.$emit("listChange",e),this._callMyParentList(e)),this.firstPageLoaded=!1,this.isTotalChangeFromAddData=!1,this.$nextTick(()=>{setTimeout(()=>{this._getNodeClientRect(".zp-paging-container-content").then(i=>{i&&this.$emit("contentHeightChanged",i[0].height)})},this.isIos?100:300)}))},_currentDataChange(e,t){if(e=[...e],this.isFirstPage?this.listRendering=!1:(this.listRendering=!0,this.listRenderingTimeout&&clearTimeout(this.listRenderingTimeout),this.$nextTick(()=>{this.listRenderingTimeout=setTimeout(()=>{this.listRendering=!1},d.c.delayTime)})),this.finalUseVirtualList&&this._setCellIndex(e,this.totalData.length===0),this.useChatRecordMode&&e.reverse(),this.isFirstPage&&this.finalConcat&&(this.totalData=[]),this.customNoMore!==-1?(this.customNoMore===1||!e.length)&&(this.loadingStatus=o.Enum.More.NoMore):(!e.length||e.length&&e.length<this.defaultPageSize)&&(this.loadingStatus=o.Enum.More.NoMore),!this.totalData.length)this.finalConcat&&(this.totalData=e),this.useChatRecordMode&&this.$nextTick(()=>{this._scrollToBottom(!1)});else if(this.useChatRecordMode){const a=e.length;let i=`z-paging-${a}`;this.totalData=[...e,...this.totalData],this.pageNo!==this.defaultPageNo?(this.privateScrollWithAnimation=0,this.$emit("update:chatIndex",a),setTimeout(()=>{this._scrollIntoView(i,30+Math.max(0,this.cacheTopHeight),!1,()=>{this.$emit("update:chatIndex",0)})},this.usePageScroll?this.isIos?50:100:200)):this.$nextTick(()=>{this._scrollToBottom(!1)})}else if(this.finalConcat){const a=this.oldScrollTop;this.totalData=[...this.totalData,...e],!this.isIos&&!this.refresherOnly&&!this.usePageScroll&&e.length&&(this.loadingMoreTimeStamp=s.u.getTime(),this.$nextTick(()=>{this.scrollToY(a)}))}else this.totalData=e;this.privateConcat=!0},_localPagingQueryList(e,t,a,i){e=Math.max(1,e),t=Math.max(1,t);const r=[...this.totalLocalPagingList],l=(e-1)*t,h=Math.min(r.length,l+t),n=r.splice(l,h-l);setTimeout(()=>i(n),a)},_saveLocalCache(e){g.index.setStorageSync(this.finalCacheKey,e)},_setListByLocalCache(){this.totalData=g.index.getStorageSync(this.finalCacheKey)||[],this.isSettingCacheList=!0},_callMyParentList(e){if(this.autowireListName.length){const t=s.u.getParent(this.$parent);t&&t[this.autowireListName]&&(t[this.autowireListName]=e)}},_callMyParentQuery(e=0,t=0){if(this.autowireQueryName){if(this.myParentQuery===-1){const a=s.u.getParent(this.$parent);a&&a[this.autowireQueryName]&&(this.myParentQuery=a[this.autowireQueryName])}this.myParentQuery!==-1&&(t>0?this.myParentQuery(e,t):this.myParentQuery(this.pageNo,this.defaultPageSize))}},_emitQuery(e,t,a){this.queryFrom=a,this.requestTimeStamp=s.u.getTime(),this.$emit("query",...m.interceptor._handleQuery(e,t,a))},_callDataPromise(e,t){for(const a in this.dataPromiseResultMap){const i=this.dataPromiseResultMap[a];e?i&&i.resolve({totalList:t,noMore:this.loadingStatus===o.Enum.More.NoMore}):i&&i.reject()}},_checkDataType(e,t,a){const i=Object.prototype.toString.call(e);return i==="[object Boolean]"?(t=e,e=[]):i==="[object Null]"?e=[]:i!=="[object Array]"&&(e=[],i!=="[object Undefined]"&&s.u.consoleErr(`${a?"setLocalPaging":"complete"}参数类型不正确，第一个参数类型必须为Array!`)),{data:e,success:t}}}};exports.dataHandleModule=y;
